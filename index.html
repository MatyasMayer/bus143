<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Strahov Express GPS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        body {
            margin: 0; padding: 15px;
            background-color: #121212; color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, sans-serif;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            -webkit-tap-highlight-color: transparent;
        }

        h1 { color: #00d2ff; margin: 10px 0; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; }

        /* Kontejner pro dynamick칠 karty */
        #cards-container { width: 100%; max-width: 450px; display: flex; flex-direction: column; gap: 15px; }

        .card {
            background: #1e1e1e; width: 100%;
            border-radius: 12px; border: 1px solid #333; overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: transform 0.3s ease, border-color 0.3s ease;
        }

        /* Styl pro nejbli쮄뫆 zast치vku */
        .card.nearest {
            border: 2px solid #00d2ff;
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.2);
            order: -1; /* V쬯y naho콏e */
        }

        .card-header {
            background: #252525; padding: 12px 15px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }

        .stop-name { font-weight: bold; font-size: 16px; color: #fff; }
        .stop-dir { font-size: 11px; color: #aaa; text-transform: uppercase; margin-top: 2px; }
        .badge-nearest { 
            display: none; background: #00d2ff; color: #000; font-size: 10px; 
            font-weight: bold; padding: 3px 6px; border-radius: 4px; text-transform: uppercase;
        }
        .card.nearest .badge-nearest { display: block; }

        .list { min-height: 60px; padding: 5px 0; }
        .row { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #2a2a2a; }
        .row:last-child { border-bottom: none; }
        
        .bus-number { background: #007bff; color: white; padding: 3px 8px; border-radius: 6px; font-weight: bold; font-size: 14px; margin-right: 8px; }
        .headsign { color: #ccc; font-size: 13px; }

        .time-group { text-align: right; }
        .time-big { font-weight: bold; font-size: 18px; color: #4cd964; }
        .time-small { font-size: 12px; color: #888; margin-top: 2px; }
        
        .delay-late { color: #ff4444; font-weight: bold; }
        .msg { text-align: center; padding: 20px; color: #666; font-style: italic; font-size: 13px; }
        .error { color: #ff4444; }

        #status-bar { font-size: 11px; color: #555; margin-top: 10px; display: flex; align-items: center; gap: 5px;}
        .dot { width: 8px; height: 8px; background: #555; border-radius: 50%; }
        .dot.active { background: #4cd964; box-shadow: 0 0 5px #4cd964; }

        /* Animace pro TE캝 */
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <h1>游뚧 Linka 143 <span style="font-size:0.6em; color:#555">GPS</span></h1>

    <div id="cards-container">
        <div class="msg">Zji코콘uji polohu a na캜칤t치m data...</div>
    </div>

    <div id="status-bar">
        <div class="dot" id="gps-dot"></div>
        <span id="status-text">캛ek치m na GPS...</span>
    </div>

    <script>
        // === KONFIGURACE ===
        const PROXY_URL = '/.netlify/functions/api'; 
        
        // Zast치vky v캜etn캩 GPS sou콏adnic
        let STOPS = [
            { 
                id: 'dejvicka', 
                name: 'Dejvick치', 
                dir: 'Strahov', // Filtr sm캩ru
                lat: 50.100900, 
                lon: 14.397078,
                data: [] // Tady se ulo쮂 sta쬰n치 data
            },
            { 
                id: 'kulatak', 
                name: 'V칤t캩zn칠 n치m캩st칤', 
                dir: 'Strahov', 
                lat: 50.098800, 
                lon: 14.396349,
                data: []
            },
            { 
                id: 'strahov', 
                name: 'Koleje Strahov', 
                dir: 'Dejvick치', 
                lat: 50.076632, 
                lon: 14.384214,
                data: []
            }
        ];

        // === 1. START APLIKACE ===
        async function init() {
            renderCards(); // Vykreslit pr치zdn칠 karty
            getUserLocation(); // Zkusit naj칤t polohu
            fetchAllData(); // St치hnout data
            
            // Intervaly
            setInterval(fetchAllData, 30000); // Data ka쬯칳ch 30s
            setInterval(updateTimeUI, 1000); // Odpo캜et ka쬯ou sekundu
        }

        // === 2. GEOLOKACE A 콎AZEN칈 ===
        function getUserLocation() {
            if (!navigator.geolocation) {
                updateStatus("GPS nedostupn칠", false);
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    updateStatus("GPS Aktivn칤", true);
                    sortStopsByDistance(pos.coords.latitude, pos.coords.longitude);
                },
                (err) => {
                    console.warn(err);
                    updateStatus("GPS vypnuto - ukazuji v코e", false);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        function sortStopsByDistance(userLat, userLon) {
            // V칳po캜et vzd치lenosti pro ka쬯ou zast치vku
            STOPS.forEach(stop => {
                stop.distance = getDistanceFromLatLonInKm(userLat, userLon, stop.lat, stop.lon);
            });

            // Se콏adit: nejmen코칤 vzd치lenost prvn칤
            STOPS.sort((a, b) => a.distance - b.distance);

            // P콏ekreslit po콏ad칤 karet (jen v DOMu)
            const container = document.getElementById('cards-container');
            STOPS.forEach((stop, index) => {
                const card = document.getElementById(`card-${stop.id}`);
                if (card) {
                    container.appendChild(card); // P콏esun na konec = 콏azen칤
                    
                    // Ozna캜it nejbli쮄뫆 (pokud je bl칤 ne 1km)
                    if (index === 0 && stop.distance < 1.5) {
                        card.classList.add('nearest');
                    } else {
                        card.classList.remove('nearest');
                    }
                }
            });
        }

        // Haversine formula (matematika pro vzd치lenost GPS)
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius Zem캩 v km
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; 
            return d;
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }

        function updateStatus(text, active) {
            document.getElementById('status-text').innerText = text;
            const dot = document.getElementById('gps-dot');
            if(active) dot.classList.add('active'); else dot.classList.remove('active');
        }

        // === 3. STAHOV츼N칈 DAT ===
        async function fetchAllData() {
            for (let stop of STOPS) {
                fetchStopData(stop);
            }
        }

        async function fetchStopData(stop) {
            // ZV칗EN LIMIT NA 200, ABYCHOM NALI 143 MEZI OSTATN칈MI AUTOBUSY
            const url = `${PROXY_URL}?names[]=${encodeURIComponent(stop.name)}&mode=departures&limit=200`;
            const listElement = document.getElementById(`list-${stop.id}`);

            try {
                const res = await fetch(url);
                
                // 1. KONTROLA, ZDA SERVER NEHL츼S칈 CHYBU
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`Chyba serveru: ${res.status} (${text})`);
                }

                const json = await res.json();

                // 2. KONTROLA CHYBY Z GOLEMIA
                if (json.error || json.error_message) {
                    throw new Error(json.error_message || "Chyba API");
                }

                const raw = json.departures || (Array.isArray(json) ? json : []);
                
                // 3. FILTRACE
                stop.data = raw.filter(d => {
                    const is143 = (d.route?.short_name === "143");
                    // O코et콏en칤, kdyby headsign neexistoval
                    const headsign = (d.trip?.headsign || "").toLowerCase();
                    const isDir = headsign.includes(stop.dir.toLowerCase());
                    return is143 && isDir;
                });
                
                renderStopContent(stop);

            } catch (e) {
                console.error(e);
                // Vyp칤코eme chybu p콏칤mo do karty, abys vid캩l, co se d캩je
                listElement.innerHTML = `<div class="msg error" style="color:orange; font-size:11px">丘멆잺 ${e.message}</div>`;
            }
        }

        // === 4. VYKRESLOV츼N칈 ===
        function renderCards() {
            const container = document.getElementById('cards-container');
            container.innerHTML = "";
            
            STOPS.forEach(stop => {
                const html = `
                <div class="card" id="card-${stop.id}">
                    <div class="card-header">
                        <div>
                            <div class="stop-name">${stop.name}</div>
                            <div class="stop-dir">Sm캩r: ${stop.dir}</div>
                        </div>
                        <div class="badge-nearest">游늸 ZDE</div>
                    </div>
                    <div class="list" id="list-${stop.id}">
                        <div class="msg">Na캜칤t치m...</div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        function renderStopContent(stop) {
            const list = document.getElementById(`list-${stop.id}`);
            if (!stop.data || stop.data.length === 0) {
                list.innerHTML = '<div class="msg">콯치dn칠 spoje v dohledu.</div>';
                return;
            }

            // Se콏adit podle 캜asu
            stop.data.sort((a, b) => new Date(a.departure_timestamp.predicted) - new Date(b.departure_timestamp.predicted));

            let html = "";
            stop.data.slice(0, 3).forEach(d => {
                // V칳po캜ty si ulo쮂셠e do atribut콢 pro updateTimeUI
                const predicted = new Date(d.departure_timestamp.predicted).toISOString();
                const delay = (d.delay && d.delay.minutes) ? d.delay.minutes : 0;
                
                // Statick칠 HTML (캜as se dopo캜칤t치 v updateTimeUI)
                let delayHtml = "";
                let color = "#4cd964";
                if(delay > 1) { 
                    delayHtml = `<span class="delay-late">(+${delay} min)</span>`;
                    color = "#ff4444";
                }

                html += `
                <div class="row" data-time="${predicted}">
                    <div>
                        <span class="bus-number">143</span> 
                        <span class="headsign">${d.trip.headsign}</span>
                    </div>
                    <div class="time-group">
                        <div class="time-big" style="color:${color}">
                            ${new Date(predicted).toLocaleTimeString('cs-CZ', {hour:'2-digit', minute:'2-digit'})}
                        </div>
                        <div class="time-small">
                            <span class="countdown">...</span> ${delayHtml}
                        </div>
                    </div>
                </div>`;
            });
            list.innerHTML = html;
            updateTimeUI(); // Hned p콏epo캜칤tat
        }

        // Funkce pro "tikatka" (odpo캜et) bez nutnosti stahovat data
        function updateTimeUI() {
            const now = new Date();
            document.querySelectorAll('.row').forEach(row => {
                const predicted = new Date(row.getAttribute('data-time'));
                const diff = Math.floor((predicted - now) / 60000);
                const span = row.querySelector('.countdown');
                
                if (span) {
                    if (diff <= 0) span.innerHTML = "<b style='color:#fff; animation: blink 1s infinite'>TE캝</b>";
                    else span.innerText = `za ${diff} min`;
                }
            });
        }

        // Spustit
        init();

    </script>
</body>
</html>